<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<script>

let hstArr = new Array(60);
let hpyArr = new Array(60);
let neuArr = new Array(60);
let sadArr = new Array(60);
let sstArr = new Array(60);

let hstTot = 0;
let hpyTot = 0;
let neuTot = 0;
let sadTot = 0;
let sstTot = 0;

let i = 0;
for (; i < 60; i++) {
  hstArr[i] = 0;
  hpyArr[i] = 0;
  neuArr[i] = 0;
  sadArr[i] = 0;
  sstArr[i] = 0;
}

function insert_data(d) {		// insert data into arrays
  hstArr[d.year-1956] += d.happiest;
  hstTot += d.happiest;
  hpyArr[d.year-1956] += d.happy;
  hpyTot += d.happy;
  neuArr[d.year-1956] += d.neutral;
  neuTot += d.neutral;
  sadArr[d.year-1956] += d.sad;
  sadTot += d.sad;
  sstArr[d.year-1956] += d.saddest;
  sstTot += d.saddest;
}

d3.json("briandata.json", function(error,data) {
  for (d of data) {
    insert_data(d);
  }
});

function visiblify(on) {
  if (on == 1) {
    hstText.attr("opacity",1);
    hpyText.attr("opacity",1);
    neuText.attr("opacity",1);
    sadText.attr("opacity",1);
    sstText.attr("opacity",1);
  } else {
    hstText.attr("opacity",0);
    hpyText.attr("opacity",0);
    neuText.attr("opacity",0);
    sadText.attr("opacity",0);
    sstText.attr("opacity",0);
  }
}

// updater function, send start and end year where start and end are [1956,2015] and end >= start
function updater(start, end) {

  let hstBuf = 0,hstW = 0;
  let hpyBuf = 0,hpyW = 0;
  let neuBuf = 0,neuW = 0;
  let sadBuf = 0,sadW = 0;
  let sstBuf = 0,sstW = 0;
  let x = 1956;

  while(x < start) {
    hstBuf += hstArr[x-1956];
    hpyBuf += hpyArr[x-1956];
    neuBuf += neuArr[x-1956];
    sadBuf += sadArr[x-1956];
    sstBuf += sstArr[x-1956];
    x += 1;
  }

  while(x <= end) {
    hstW += hstArr[x-1956];
    hpyW += hpyArr[x-1956];
    neuW += neuArr[x-1956];
    sadW += sadArr[x-1956];
    sstW += sstArr[x-1956];
    x += 1;
  }

  happiestFront.transition()
            .duration(100)
            .attr("x", width*hstBuf/hstTot)
            .attr("width", width*hstW/hstTot);

  happyFront.transition()
            .duration(100)
            .attr("x", width*hpyBuf/hpyTot)
            .attr("width", width*hpyW/hpyTot);

  neutralFront.transition()
            .duration(100)
            .attr("x", width*neuBuf/neuTot)
            .attr("width", width*neuW/neuTot);

  sadFront.transition()
            .duration(100)
            .attr("x", width*sadBuf/sadTot)
            .attr("width", width*sadW/sadTot);

  saddestFront.transition()
            .duration(100)
            .attr("x", width*sstBuf/sstTot)
            .attr("width", width*sstW/sstTot);

  hstText.text(((hstW/hstTot*100).toFixed(0)).toString().concat("%"));
  hpyText.text(((hpyW/hpyTot*100).toFixed(0)).toString().concat("%"));
  neuText.text(((neuW/neuTot*100).toFixed(0)).toString().concat("%"));
  sadText.text(((sadW/sadTot*100).toFixed(0)).toString().concat("%"));
  sstText.text(((sstW/sstTot*100).toFixed(0)).toString().concat("%"));

  if (width*hstW/hstTot >= 35) {
    hstText.attr("x", width*hstBuf/hstTot + 3);
  } else if (width - width*hstBuf/hstTot < 35) {
    hstText.attr("x", width - 35 - (width - width*hstBuf/hstTot));
  } else {
    hstText.attr("x", width*hstBuf/hstTot + width*hstW/hstTot + 3);
  }

  if (width*hpyW/hpyTot >= 35) {
    hpyText.attr("x", width*hpyBuf/hpyTot + 3);
  } else if (width - width*hpyBuf/hpyTot < 35) {
    hpyText.attr("x", width - 35 - (width - width*hpyBuf/hpyTot));
  } else {
    hpyText.attr("x", width*hpyBuf/hpyTot + width*hpyW/hpyTot + 3);
  }

  if (width*neuW/neuTot >= 35) {
    neuText.attr("x", width*neuBuf/neuTot + 3);
  } else if (width - width*neuBuf/neuTot < 35) {
    neuText.attr("x", width - 35 - (width - width*neuBuf/neuTot));
  } else {
    neuText.attr("x", width*neuBuf/neuTot + width*neuW/neuTot + 3);
  }

  if (width*sadW/sadTot >= 35) {
    sadText.attr("x", width*sadBuf/sadTot + 3);
  } else if (width - width*sadBuf/sadTot < 35) {
    sadText.attr("x", width - 35 - (width - width*sadBuf/sadTot));
  } else {
    sadText.attr("x", width*sadBuf/sadTot + width*sadW/sadTot + 3);
  }

  if (width*sstW/sstTot >= 35) {
    sstText.attr("x", width*sstBuf/sstTot + 3);
  } else if (width - width*sstBuf/sstTot < 35) {
    sstText.attr("x", width - 35 - (width - width*sstBuf/sstTot));
  } else {
    sstText.attr("x", width*sstBuf/sstTot + width*sstW/sstTot + 3);
  }
}

let width = 600,
    height = 500,
    button_border = height*.9;

let svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);

let happiestBack = svg.append("rect")
  .attr("x",0)
  .attr("y",0)
  .attr("width",width)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#F3E141")
  .style("opacity",0.5);
  //.on('click',function() { updater(1956,2000); });

let happyBack = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.2)
  .attr("width",width)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#DED46F")
  .style("opacity",0.5);
  //.on('click',function() { updater(1956,1956); });

let neutralBack = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.4)
  .attr("width",width)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#C6C792")
  .style("opacity",0.5);
  //.on('click',function() { updater(1979,1984); });

let sadBack = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.6)
  .attr("width",width)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#A8BBB2")
  .style("opacity",0.5);
  //.on('click',function() { updater(1980,1995); visiblify(1);});

let saddestBack = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.8)
  .attr("width",width)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#7FB0D0")
  .style("opacity",0.5);
  //.on('click',function() { updater(2015,2015); visiblify(0);});

let happiestFront = svg.append("rect")
  .attr("x",0)
  .attr("y",0)
  .attr("width",0)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#F3E141")

let happyFront = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.2)
  .attr("width",0)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#DED46F")

let neutralFront = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.4)
  .attr("width",0)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#C6C792")

let sadFront = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.6)
  .attr("width",0)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#A8BBB2")

let saddestFront = svg.append("rect")
  .attr("x",0)
  .attr("y",height*.8)
  .attr("width",0)
  .attr("height",height*.2)
  .attr("stroke","white")
  .attr("stroke-width",3)
  .attr("fill","#7FB0D0")

let hstText = svg.append("text")
  .attr("x",3)
  .attr("y",height*.12)
  .style("font-family","Arial");

let hpyText = svg.append("text")
  .attr("x",3)
  .attr("y",height*.32)
  .style("font-family","Arial");

let neuText = svg.append("text")
  .attr("x",3)
  .attr("y",height*.52)
  .style("font-family","Arial");

let sadText = svg.append("text")
  .attr("x",3)
  .attr("y",height*.72)
  .style("font-family","Arial");

let sstText = svg.append("text")
  .attr("x",3)
  .attr("y",height*.92)
  .style("font-family","Arial");

</script>
</body>
</html>